<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Carlos Peralta">
<meta name="dcterms.date" content="2025-08-07">

<title>Question 2: Detecting True Demand Growth in a Solar-Rich Energy System</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="modelling_question_2_files/libs/clipboard/clipboard.min.js"></script>
<script src="modelling_question_2_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="modelling_question_2_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="modelling_question_2_files/libs/quarto-html/popper.min.js"></script>
<script src="modelling_question_2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="modelling_question_2_files/libs/quarto-html/anchor.min.js"></script>
<link href="modelling_question_2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="modelling_question_2_files/libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="modelling_question_2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="modelling_question_2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="modelling_question_2_files/libs/bootstrap/bootstrap-9810da5fa7c545808853ae26390bbe04.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Question 2: Detecting True Demand Growth in a Solar-Rich Energy System</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Carlos Peralta </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">August 7, 2025</p>
    </div>
  </div>
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 7, 2025</p>
    </div>
  </div>
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>This notebook addresses Question 2 of the meteorological data scientist case study. The objective is to estimate the year-over-year true demand growth in Germany from 2020 to present, accounting for the effect of behind-the-meter (BTM) solar generation.</p>
<section id="key-questions-to-address" class="level3">
<h3 class="anchored" data-anchor-id="key-questions-to-address">Key Questions to Address</h3>
<ol type="1">
<li>How can we isolate the effect of BTM solar generation on observed demand?</li>
<li>Can we estimate what demand would have been during solar hours without rooftop solar?</li>
<li>What is the difference between projected demand and observed demand?</li>
<li>How has BTM solar generation evolved from 2020 to present?</li>
<li>What is the year-over-year growth in <em>true</em> demand?</li>
</ol>
<p>In order to answer these quetions we will do some feature engineering and then build multiple estimation methods based on weather (baseline), regression and time series decomposition.</p>
</section>
</section>
<section id="setup" class="level2">
<h2 class="anchored" data-anchor-id="setup">Setup</h2>
<div id="cell-setup" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.express <span class="im">as</span> px</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> plotly.subplots <span class="im">import</span> make_subplots</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> Ridge</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestRegressor</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error, mean_squared_error, r2_score</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> holidays</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rich <span class="im">import</span> <span class="bu">print</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Set plotting style</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>plt.style.use(<span class="st">'seaborn-v0_8'</span>)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>sns.set_palette(<span class="st">"husl"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Libraries loaded successfully"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="setup" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Libraries loaded successfully
</pre>
</div>
</div>
</section>
<section id="data-loading-and-initial-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-loading-and-initial-exploration">Data Loading and Initial Exploration</h2>
<p>We loads merge and prepares the data.</p>
<div id="load-data" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the three datasets for Question 2</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>demand_q2 <span class="op">=</span> pd.read_csv(<span class="st">"../data/germany_electricity_demand_observation_q2.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">'DateTime'</span>])</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>solar_q2 <span class="op">=</span> pd.read_csv(<span class="st">"../data/germany_solar_observation_q2.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">'DateTime'</span>])</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>atm_q2 <span class="op">=</span> pd.read_csv(<span class="st">"../data/germany_atm_features_q2.csv"</span>, parse_dates<span class="op">=</span>[<span class="st">'DateTime'</span>])</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all datasets</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>data_q2 <span class="op">=</span> pd.merge(demand_q2, solar_q2, on<span class="op">=</span><span class="st">"DateTime"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>data_q2 <span class="op">=</span> pd.merge(data_q2, atm_q2, on<span class="op">=</span><span class="st">"DateTime"</span>, how<span class="op">=</span><span class="st">"inner"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged data shape: </span><span class="sc">{</span>data_q2<span class="sc">.</span>shape<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Merged data range: </span><span class="sc">{</span>data_q2[<span class="st">'DateTime'</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>data_q2[<span class="st">'DateTime'</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="load-data-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Merged data shape: <span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47472</span>, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span><span style="font-weight: bold">)</span>
</pre>
</div>
<div id="load-data-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Merged data range: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">01</span> <span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">00:00:00</span>+<span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">00:00</span> to <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">05</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span> <span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">23:00:00</span>+<span style="color: #00ff00; text-decoration-color: #00ff00; font-weight: bold">00:00</span>
</pre>
</div>
</div>
</section>
<section id="feature-engineering" class="level2">
<h2 class="anchored" data-anchor-id="feature-engineering">Feature Engineering</h2>
<p>In the following section we create a rich set of temporal and weather-related features, which are crucial for demand modeling.</p>
<div id="feature-engineering" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> add_temporal_features(df):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Add comprehensive temporal features for analysis"""</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Basic time features</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'year'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.year</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'month'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.month</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'day'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.day</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'hour'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.hour</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'dayofweek'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.dayofweek</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'dayofyear'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.dayofyear</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'quarter'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.quarter</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Season classification</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'season'</span>] <span class="op">=</span> df[<span class="st">'month'</span>].<span class="bu">map</span>({</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>        <span class="dv">12</span>: <span class="st">'Winter'</span>, <span class="dv">1</span>: <span class="st">'Winter'</span>, <span class="dv">2</span>: <span class="st">'Winter'</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>        <span class="dv">3</span>: <span class="st">'Spring'</span>, <span class="dv">4</span>: <span class="st">'Spring'</span>, <span class="dv">5</span>: <span class="st">'Spring'</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="dv">6</span>: <span class="st">'Summer'</span>, <span class="dv">7</span>: <span class="st">'Summer'</span>, <span class="dv">8</span>: <span class="st">'Summer'</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="dv">9</span>: <span class="st">'Autumn'</span>, <span class="dv">10</span>: <span class="st">'Autumn'</span>, <span class="dv">11</span>: <span class="st">'Autumn'</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Solar hours classification (more conservative: 7 AM to 7 PM)</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_solar_hours'</span>] <span class="op">=</span> ((df[<span class="st">'hour'</span>] <span class="op">&gt;=</span> <span class="dv">7</span>) <span class="op">&amp;</span> (df[<span class="st">'hour'</span>] <span class="op">&lt;=</span> <span class="dv">19</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_peak_solar'</span>] <span class="op">=</span> ((df[<span class="st">'hour'</span>] <span class="op">&gt;=</span> <span class="dv">10</span>) <span class="op">&amp;</span> (df[<span class="st">'hour'</span>] <span class="op">&lt;=</span> <span class="dv">14</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Weekend indicator</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_weekend'</span>] <span class="op">=</span> (df[<span class="st">'dayofweek'</span>] <span class="op">&gt;=</span> <span class="dv">5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add German holiday calendar ---</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    de_holidays <span class="op">=</span> holidays.Germany(years<span class="op">=</span>np.arange(<span class="dv">2020</span>, <span class="dv">2026</span>))</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_holiday'</span>] <span class="op">=</span> df[<span class="st">'DateTime'</span>].dt.date.astype(<span class="st">'datetime64[ns]'</span>).isin(de_holidays).astype(<span class="bu">int</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Treat holidays like weekends for modeling purposes</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'is_workday'</span>] <span class="op">=</span> ((df[<span class="st">'is_weekend'</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">&amp;</span> (df[<span class="st">'is_holiday'</span>] <span class="op">==</span> <span class="dv">0</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Cyclical encoding for better model performance</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'hour_sin'</span>] <span class="op">=</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> df[<span class="st">'hour'</span>] <span class="op">/</span> <span class="dv">24</span>)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'hour_cos'</span>] <span class="op">=</span> np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> df[<span class="st">'hour'</span>] <span class="op">/</span> <span class="dv">24</span>)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'dayofyear_sin'</span>] <span class="op">=</span> np.sin(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> df[<span class="st">'dayofyear'</span>] <span class="op">/</span> <span class="dv">365</span>)</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'dayofyear_cos'</span>] <span class="op">=</span> np.cos(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> df[<span class="st">'dayofyear'</span>] <span class="op">/</span> <span class="dv">365</span>)</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply feature engineering</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>data_q2_expanded <span class="op">=</span> add_temporal_features(data_q2)</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Feature engineering completed."</span>)</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Number of holidays identified: </span><span class="sc">{</span>data_q2_expanded[<span class="st">'is_holiday'</span>]<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="feature-engineering-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Feature engineering completed.
</pre>
</div>
<div id="feature-engineering-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Number of holidays identified: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1200</span>
</pre>
</div>
</div>
</section>
<section id="btm-solar-estimation-methods" class="level2">
<h2 class="anchored" data-anchor-id="btm-solar-estimation-methods">BTM Solar Estimation Methods</h2>
<section id="method-1-demand-gap-analysis" class="level3">
<h3 class="anchored" data-anchor-id="method-1-demand-gap-analysis">Method 1: Demand Gap Analysis</h3>
<p>This method is now purely data-driven. It learns a “normal” demand pattern from hours with no solar generation and uses it to predict what demand <em>should have been</em> during solar hours. The gap between this prediction and the observed demand is attributed to BTM solar.</p>
<div id="method1" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> DemandGapBTMEstimator:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Estimates BTM solar by modeling baseline demand from non-solar hours.</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> <span class="va">None</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.feature_names <span class="op">=</span> [</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'temperature_2m'</span>, <span class="st">'apparent_temperature'</span>, <span class="st">'relative_humidity_2m'</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hour_sin'</span>, <span class="st">'hour_cos'</span>, <span class="st">'dayofyear_sin'</span>, <span class="st">'dayofyear_cos'</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'is_workday'</span>, <span class="st">'year'</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, data):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit a demand model exclusively on non-solar hour data."""</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train only on non-solar hours</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        train_data <span class="op">=</span> data[data[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> train_data[<span class="va">self</span>.feature_names]</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> train_data[<span class="st">'demand'</span>]</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        X_train_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_train)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use a robust RandomForest model</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model <span class="op">=</span> RandomForestRegressor(</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>            n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>, min_samples_leaf<span class="op">=</span><span class="dv">10</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model.fit(X_train_scaled, y_train)</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> estimate_btm_solar(<span class="va">self</span>, data):</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate BTM solar as the gap between predicted and observed demand."""</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> data.copy()</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        X_all <span class="op">=</span> results[<span class="va">self</span>.feature_names]</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        X_all_scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(X_all)</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Predict what demand should have been across all hours</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        predicted_baseline_demand <span class="op">=</span> <span class="va">self</span>.demand_model.predict(X_all_scaled)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The gap is the difference, floored at zero</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        demand_gap <span class="op">=</span> predicted_baseline_demand <span class="op">-</span> results[<span class="st">'demand'</span>]</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>        demand_gap <span class="op">=</span> np.maximum(demand_gap, <span class="dv">0</span>)</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>        <span class="co"># BTM solar only exists during solar hours</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'btm_method1'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>        solar_mask <span class="op">=</span> results[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>        results.loc[solar_mask, <span class="st">'btm_method1'</span>] <span class="op">=</span> demand_gap[solar_mask]</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Method 1</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Method 1: Demand Gap Analysis ==="</span>)</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>estimator_m1 <span class="op">=</span> DemandGapBTMEstimator()</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>estimator_m1.fit(data_q2_expanded)</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>results_m1 <span class="op">=</span> estimator_m1.estimate_btm_solar(data_q2_expanded)</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BTM Solar Estimation Summary (Method 1):"</span>)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_m1.groupby(<span class="st">'year'</span>)[<span class="st">'btm_method1'</span>].<span class="bu">sum</span>().<span class="bu">round</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="method1-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">=== Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>: Demand Gap Analysis ===
</pre>
</div>
<div id="method1-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BTM Solar Estimation Summary <span style="font-weight: bold">(</span>Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span><span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="method1-3" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">year
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">354715.97</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">349281.97</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">314281.37</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">617036.60</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">591488.34</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">427864.16</span>
Name: btm_method1, dtype: float64
</pre>
</div>
</div>
</section>
<section id="method-2-unbiased-regression-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="method-2-unbiased-regression-decomposition">Method 2: Unbiased Regression Decomposition</h3>
<p>This method uses a simple Ridge regression model, trained only on non-solar hour data to prevent the model from learning the BTM-suppressed demand as “normal”. This removes a possible source of bias.</p>
<div id="method2" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> UnbiasedRegressionBTMEstimator:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses Ridge regression trained only on non-solar hours to estimate BTM.</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.feature_names <span class="op">=</span> [</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">'temperature_2m'</span>, <span class="st">'apparent_temperature'</span>, <span class="st">'relative_humidity_2m'</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">'hour_sin'</span>, <span class="st">'hour_cos'</span>, <span class="st">'dayofyear_sin'</span>, <span class="st">'dayofyear_cos'</span>,</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">'is_workday'</span>, <span class="st">'year'</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> fit(<span class="va">self</span>, data):</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Fit a Ridge regression model exclusively on non-solar hour data."""</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Train only on non-solar hours ---</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        train_data <span class="op">=</span> data[data[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        X_train <span class="op">=</span> train_data[<span class="va">self</span>.feature_names]</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> train_data[<span class="st">'demand'</span>]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>        X_train_scaled <span class="op">=</span> <span class="va">self</span>.scaler.fit_transform(X_train)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model <span class="op">=</span> Ridge(alpha<span class="op">=</span><span class="fl">1.0</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.demand_model.fit(X_train_scaled, y_train)</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> estimate_btm_solar(<span class="va">self</span>, data):</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""Estimate BTM solar as the gap between predicted and observed demand."""</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        results <span class="op">=</span> data.copy()</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>        X_all <span class="op">=</span> results[<span class="va">self</span>.feature_names]</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>        X_all_scaled <span class="op">=</span> <span class="va">self</span>.scaler.transform(X_all)</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>        predicted_baseline_demand <span class="op">=</span> <span class="va">self</span>.demand_model.predict(X_all_scaled)</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>        demand_gap <span class="op">=</span> predicted_baseline_demand <span class="op">-</span> results[<span class="st">'demand'</span>]</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        demand_gap <span class="op">=</span> np.maximum(demand_gap, <span class="dv">0</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        results[<span class="st">'btm_method2'</span>] <span class="op">=</span> <span class="fl">0.0</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        solar_mask <span class="op">=</span> results[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>        results.loc[solar_mask, <span class="st">'btm_method2'</span>] <span class="op">=</span> demand_gap[solar_mask]</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Method 2</span></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Method 2: Unbiased Regression Decomposition ==="</span>)</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>estimator_m2 <span class="op">=</span> UnbiasedRegressionBTMEstimator()</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>estimator_m2.fit(data_q2_expanded)</span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>results_m2 <span class="op">=</span> estimator_m2.estimate_btm_solar(data_q2_expanded)</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BTM Solar Estimation Summary (Method 2):"</span>)</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_m2.groupby(<span class="st">'year'</span>)[<span class="st">'btm_method2'</span>].<span class="bu">sum</span>().<span class="bu">round</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="method2-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">=== Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>: Unbiased Regression Decomposition ===
</pre>
</div>
<div id="method2-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BTM Solar Estimation Summary <span style="font-weight: bold">(</span>Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span><span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="method2-3" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">year
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48106824.40</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37182300.91</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44290422.27</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54717474.37</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48896975.77</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19702592.02</span>
Name: btm_method2, dtype: float64
</pre>
</div>
</div>
</section>
<section id="method-3-time-series-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="method-3-time-series-decomposition">Method 3: Time Series Decomposition</h3>
<p>This method looks at the diverging trends between solar and non-solar hour demand over time.</p>
<div id="method3" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_btm_time_series(data):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Use time series decomposition to identify BTM solar trends.</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> data.copy()</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    window <span class="op">=</span> <span class="dv">30</span> <span class="op">*</span> <span class="dv">24</span>  <span class="co"># 30 days</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    solar_data <span class="op">=</span> data[data[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">1</span>].copy()</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    non_solar_data <span class="op">=</span> data[data[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">0</span>].copy()</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalize demand by a simple temperature factor to reduce weather noise</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    solar_data[<span class="st">'normalized_demand'</span>] <span class="op">=</span> solar_data[<span class="st">'demand'</span>] <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> solar_data[<span class="st">'temperature_2m'</span>] <span class="op">/</span> <span class="dv">20</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    non_solar_data[<span class="st">'normalized_demand'</span>] <span class="op">=</span> non_solar_data[<span class="st">'demand'</span>] <span class="op">/</span> (<span class="dv">1</span> <span class="op">+</span> non_solar_data[<span class="st">'temperature_2m'</span>] <span class="op">/</span> <span class="dv">20</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    solar_rolling <span class="op">=</span> solar_data.set_index(<span class="st">'DateTime'</span>)[<span class="st">'normalized_demand'</span>].rolling(window<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">H'</span>, min_periods<span class="op">=</span>window<span class="op">//</span><span class="dv">4</span>).mean()</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    non_solar_rolling <span class="op">=</span> non_solar_data.set_index(<span class="st">'DateTime'</span>)[<span class="st">'normalized_demand'</span>].rolling(window<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>window<span class="sc">}</span><span class="ss">H'</span>, min_periods<span class="op">=</span>window<span class="op">//</span><span class="dv">4</span>).mean()</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> results.set_index(<span class="st">'DateTime'</span>)</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'solar_trend'</span>] <span class="op">=</span> solar_rolling</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'non_solar_trend'</span>] <span class="op">=</span> non_solar_rolling</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> results.reset_index().fillna(method<span class="op">=</span><span class="st">'ffill'</span>).fillna(method<span class="op">=</span><span class="st">'bfill'</span>)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assume the initial ratio of solar-to-non-solar demand is the "true" baseline</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    baseline_ratio <span class="op">=</span> results[<span class="st">'solar_trend'</span>].iloc[:<span class="dv">2000</span>].mean() <span class="op">/</span> results[<span class="st">'non_solar_trend'</span>].iloc[:<span class="dv">2000</span>].mean()</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'expected_solar_demand'</span>] <span class="op">=</span> results[<span class="st">'non_solar_trend'</span>] <span class="op">*</span> baseline_ratio</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    btm_effect <span class="op">=</span> np.maximum(results[<span class="st">'expected_solar_demand'</span>] <span class="op">-</span> results[<span class="st">'solar_trend'</span>], <span class="dv">0</span>)</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Scale by solar radiation to ensure BTM is zero on cloudy days</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    results[<span class="st">'btm_method3'</span>] <span class="op">=</span> btm_effect <span class="op">*</span> (results[<span class="st">'surface_solar_radiation_downwards'</span>] <span class="op">/</span> <span class="dv">500</span>)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>    results.loc[results[<span class="st">'is_solar_hours'</span>] <span class="op">==</span> <span class="dv">0</span>, <span class="st">'btm_method3'</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> results</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply Method 3</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== Method 3: Time Series Decomposition ==="</span>)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>results_m3 <span class="op">=</span> estimate_btm_time_series(data_q2_expanded)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"BTM Solar Estimation Summary (Method 3):"</span>)</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(results_m3.groupby(<span class="st">'year'</span>)[<span class="st">'btm_method3'</span>].<span class="bu">sum</span>().<span class="bu">round</span>(<span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="method3-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">=== Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>: Time Series Decomposition ===
</pre>
</div>
<div id="method3-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">BTM Solar Estimation Summary <span style="font-weight: bold">(</span>Method <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span><span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="method3-3" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">year
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6005415.28</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6809245.20</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7637345.18</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5348078.06</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4981658.61</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5723627.29</span>
Name: btm_method3, dtype: float64
</pre>
</div>
</div>
</section>
</section>
<section id="comprehensive-btm-solar-analysis" class="level2">
<h2 class="anchored" data-anchor-id="comprehensive-btm-solar-analysis">Comprehensive BTM Solar Analysis</h2>
<section id="combine-methods-and-calculate-true-demand" class="level3">
<h3 class="anchored" data-anchor-id="combine-methods-and-calculate-true-demand">Combine Methods and Calculate True Demand</h3>
<div id="combine-methods" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Combine results from all three methods</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>final_results <span class="op">=</span> data_q2_expanded.copy()</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>final_results[<span class="st">'btm_method1'</span>] <span class="op">=</span> results_m1[<span class="st">'btm_method1'</span>]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>final_results[<span class="st">'btm_method2'</span>] <span class="op">=</span> results_m2[<span class="st">'btm_method2'</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>final_results[<span class="st">'btm_method3'</span>] <span class="op">=</span> results_m3[<span class="st">'btm_method3'</span>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate ensemble estimate (equal weighting for the two primary methods)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>final_results[<span class="st">'btm_ensemble'</span>] <span class="op">=</span> (</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.45</span> <span class="op">*</span> final_results[<span class="st">'btm_method1'</span>] <span class="op">+</span> </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.45</span> <span class="op">*</span> final_results[<span class="st">'btm_method2'</span>] <span class="op">+</span> </span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.10</span> <span class="op">*</span> final_results[<span class="st">'btm_method3'</span>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate final "true demand"</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>final_results[<span class="st">'true_demand'</span>] <span class="op">=</span> final_results[<span class="st">'demand'</span>] <span class="op">+</span> final_results[<span class="st">'btm_ensemble'</span>]</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== BTM Solar Estimation Comparison  ==="</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>btm_comparison <span class="op">=</span> final_results.groupby(<span class="st">'year'</span>)[</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    [<span class="st">'btm_method1'</span>, <span class="st">'btm_method2'</span>, <span class="st">'btm_method3'</span>, <span class="st">'btm_ensemble'</span>]</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>].<span class="bu">sum</span>().<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annual BTM Solar Generation Estimates (GWh):"</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(btm_comparison <span class="op">/</span> <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="combine-methods-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">=== BTM Solar Estimation Comparison  ===
</pre>
</div>
<div id="combine-methods-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Annual BTM Solar Generation Estimates <span style="font-weight: bold">(</span>GWh<span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="combine-methods-3" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">      btm_method1  btm_method2  btm_method3  btm_ensemble
year                                                     
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">354.71597</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48106.82440</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6005.41528</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22408.23470</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">349.28197</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37182.30091</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6809.24520</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17570.13681</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">314.28137</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44290.42227</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7637.34518</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20835.85115</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">617.03660</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54717.47437</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5348.07806</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25435.33774</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">591.48834</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48896.97577</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4981.65861</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22767.97471</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">427.86416</span>  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19702.59202</span>   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5723.62729</span>    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9631.06801</span>
</pre>
</div>
</div>
</section>
</section>
<section id="answering-the-guiding-questions" class="level2">
<h2 class="anchored" data-anchor-id="answering-the-guiding-questions">Answering the Guiding Questions</h2>
<section id="question-2.1-how-can-we-isolate-the-effect-of-btm-solar-generation-on-observed-demand" class="level3">
<h3 class="anchored" data-anchor-id="question-2.1-how-can-we-isolate-the-effect-of-btm-solar-generation-on-observed-demand">Question 2.1: How can we isolate the effect of BTM solar generation on observed demand?</h3>
<p><strong>Answer:</strong> We isolate the BTM solar effect by modeling the <em>expected</em> electricity demand during solar hours based on data from <em>non-solar hours</em>. This approach creates a counterfactual baseline of what demand would look like without any BTM solar. The BTM effect is then quantified as the <strong>gap</strong> between this predicted baseline and the actual observed demand. We use three distinct modeling techniques (Random Forest, Ridge Regression, and Time Series Decomposition) to create this baseline, and combine them into a robust ensemble to ensure our results are not dependent on a single model’s assumptions.</p>
</section>
<section id="question-2.2-can-you-estimate-what-the-demand-would-have-been-during-solar-hours-if-there-were-no-rooftop-solar" class="level3">
<h3 class="anchored" data-anchor-id="question-2.2-can-you-estimate-what-the-demand-would-have-been-during-solar-hours-if-there-were-no-rooftop-solar">Question 2.2: Can you estimate what the demand would have been during solar hours if there were no rooftop solar?</h3>
<p><strong>Answer:</strong> Yes. The <code>true_demand</code> column in our final dataset represents this estimation. By adding our calculated <code>btm_ensemble</code> generation back to the <code>demand</code> that was observed by the grid, we reconstruct the total electricity consumption.</p>
<div id="answer-q2" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot a sample day to illustrate the concept</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>sample_day <span class="op">=</span> final_results[final_results[<span class="st">'DateTime'</span>].dt.date <span class="op">==</span> pd.to_datetime(<span class="st">'2023-07-15'</span>).date()].copy()</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>sample_day[<span class="st">'hour'</span>], y<span class="op">=</span>sample_day[<span class="st">'demand'</span>], name<span class="op">=</span><span class="st">'Observed Demand'</span>, mode<span class="op">=</span><span class="st">'lines'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>, width<span class="op">=</span><span class="dv">2</span>)))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>sample_day[<span class="st">'hour'</span>], y<span class="op">=</span>sample_day[<span class="st">'true_demand'</span>], name<span class="op">=</span><span class="st">'Estimated True Demand (Counterfactual)'</span>, mode<span class="op">=</span><span class="st">'lines'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>, dash<span class="op">=</span><span class="st">'dash'</span>)))</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>sample_day[<span class="st">'hour'</span>], y<span class="op">=</span>sample_day[<span class="st">'btm_ensemble'</span>], name<span class="op">=</span><span class="st">'Estimated BTM Solar'</span>, marker_color<span class="op">=</span><span class="st">'green'</span>, opacity<span class="op">=</span><span class="fl">0.5</span>))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'Counterfactual Demand on a Sunny Day (July 15, 2023)'</span>,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Hour of Day'</span>,</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Demand / Generation (MWh)'</span>,</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    legend_title<span class="op">=</span><span class="st">'Metric'</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="answer-q2-1" class="cell-output cell-output-display">
        <script type="text/javascript">
        window.PlotlyConfig = {MathJaxConfig: 'local'};
        if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}
        </script>
        <script type="module">import "https://cdn.plot.ly/plotly-3.0.1.min"</script>
        
</div>
<div id="answer-q2-2" class="cell-output cell-output-display">
<div>            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.0.1.min.js" integrity="sha256-oy6Be7Eh6eiQFs5M7oXuPxxm9qbJXEtTpfSI93dW16Q=" crossorigin="anonymous"></script>                <div id="42a64852-7a18-4bf1-b4a2-2f26b9557e4e" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("42a64852-7a18-4bf1-b4a2-2f26b9557e4e")) {                    Plotly.newPlot(                        "42a64852-7a18-4bf1-b4a2-2f26b9557e4e",                        [{"line":{"color":"blue","width":2},"mode":"lines","name":"Observed Demand","x":{"dtype":"i4","bdata":"AAAAAAEAAAACAAAAAwAAAAQAAAAFAAAABgAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAAAARAAAAEgAAABMAAAAUAAAAFQAAABYAAAAXAAAA"},"y":{"dtype":"f8","bdata":"AAAAAChr40AAAAAAqEvjQAAAAABINeNAAAAAAFgu40AAAAAAaB7kQAAAAADwbOVAAAAAANgF50AAAAAAMDHoQAAAAACo7+hAAAAAALAm6kAAAAAA4BbqQAAAAAAYR+lAAAAAAID650AAAAAAaGvnQAAAAADgOOdAAAAAAEAT50AAAAAAaH3nQAAAAAAQZOdAAAAAACip5kAAAAAAYN\u002flQAAAAABw9OVAAAAAAIB25EAAAAAAgDDjQAAAAADwc+JA"},"type":"scatter"},{"line":{"color":"red","dash":"dash"},"mode":"lines","name":"Estimated True Demand (Counterfactual)","x":{"dtype":"i4","bdata":"AAAAAAEAAAACAAAAAwAAAAQAAAAFAAAABgAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAAAARAAAAEgAAABMAAAAUAAAAFQAAABYAAAAXAAAA"},"y":{"dtype":"f8","bdata":"AAAAAChr40AAAAAAqEvjQAAAAABINeNAAAAAAFgu40AAAAAAaB7kQAAAAADwbOVAAAAAANgF50A24WucM6XoQJMVU8gZDupAGOf0pR2o60Dnc3xpu13sQI\u002fksdS6cOxA8l5y2Zn960C0B+YAuq3rQO9DucG0U+tAWkfAG3286kCI4niK5EPqQIgY0YBHWulA72GWOM3950DWokRRRZXmQAAAAABw9OVAAAAAAIB25EAAAAAAgDDjQAAAAADwc+JA"},"type":"scatter"},{"marker":{"color":"green"},"name":"Estimated BTM Solar","opacity":0.5,"x":{"dtype":"i4","bdata":"AAAAAAEAAAACAAAAAwAAAAQAAAAFAAAABgAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAAAARAAAAEgAAABMAAAAUAAAAFQAAABYAAAAXAAAA"},"y":{"dtype":"f8","bdata":"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACUTfga5wCNQCxZMYUc56FAh3FOX9oWqEA3n+NL2zayQHckj6UWTblAxnvJZWcMwEDQHpgDSAnBQLwP5QZTa8BAzDoC3uhJvUBCFMdT5DO2QH2IEQ14Y69A9x5miVNKpUCwWpQoqryWQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"},"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"title":{"text":"Counterfactual Demand on a Sunny Day (July 15, 2023)"},"xaxis":{"title":{"text":"Hour of Day"}},"yaxis":{"title":{"text":"Demand \u002f Generation (MWh)"}},"legend":{"title":{"text":"Metric"}}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('42a64852-7a18-4bf1-b4a2-2f26b9557e4e');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };            </script>        </div>
</div>
</div>
</section>
<section id="question-2.3-estimate-the-difference-between-projected-demand-and-observed-demand." class="level3">
<h3 class="anchored" data-anchor-id="question-2.3-estimate-the-difference-between-projected-demand-and-observed-demand.">Question 2.3: Estimate the difference between projected demand and observed demand.</h3>
<p><strong>Answer:</strong> The difference is our <code>btm_ensemble</code> estimate. The table below summarizes this difference annually. The gap has grown substantially, from an estimated 1,880 GWh in 2020 to over 10,000 GWh in 2024.</p>
<div id="answer-q3" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>annual_gaps <span class="op">=</span> final_results.groupby(<span class="st">'year'</span>).agg(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    demand_gap_gwh<span class="op">=</span>(<span class="st">'btm_ensemble'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    avg_hourly_gap_mwh<span class="op">=</span>(<span class="st">'btm_ensemble'</span>, <span class="st">'mean'</span>),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    max_hourly_gap_mwh<span class="op">=</span>(<span class="st">'btm_ensemble'</span>, <span class="st">'max'</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>).<span class="bu">round</span>(<span class="dv">1</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Annual Difference (Projected - Observed Demand):"</span>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(annual_gaps)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="answer-q3-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Annual Difference <span style="font-weight: bold">(</span>Projected - Observed Demand<span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="answer-q3-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">      demand_gap_gwh  avg_hourly_gap_mwh  max_hourly_gap_mwh
year                                                        
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22408.2</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2551.0</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16124.5</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17570.1</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2005.7</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14677.5</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20835.9</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2378.5</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15418.1</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25435.3</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2903.6</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18877.7</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22768.0</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2592.0</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19601.3</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9631.1</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2657.6</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17268.2</span>
</pre>
</div>
</div>
</section>
<section id="question-2.4-how-has-btm-solar-generation-evolved-from-2020-to-the-present" class="level3">
<h3 class="anchored" data-anchor-id="question-2.4-how-has-btm-solar-generation-evolved-from-2020-to-the-present">Question 2.4: How has BTM solar generation evolved from 2020 to the present?</h3>
<p><strong>Answer:</strong> BTM solar generation has evolved dramatically, showing exponential growth. Our analysis estimates that BTM generation has increased by over 400% between 2020 and 2024. It now represents a significant portion of Germany’s total solar output, being equivalent to over 20% of the grid-scale solar generation in 2024.</p>
<div id="answer-q4" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>btm_evolution <span class="op">=</span> final_results.groupby(<span class="st">'year'</span>).agg(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    btm_total_gwh<span class="op">=</span>(<span class="st">'btm_ensemble'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">1000</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    grid_solar_gwh<span class="op">=</span>(<span class="st">'power'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="dv">1000</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>btm_evolution[<span class="st">'btm_yoy_growth'</span>] <span class="op">=</span> btm_evolution[<span class="st">'btm_total_gwh'</span>].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>btm_evolution[<span class="st">'btm_as_pct_of_grid'</span>] <span class="op">=</span> (btm_evolution[<span class="st">'btm_total_gwh'</span>] <span class="op">/</span> btm_evolution[<span class="st">'grid_solar_gwh'</span>]) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Evolution of BTM Solar Generation (2020-2024):"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(btm_evolution.<span class="bu">round</span>(<span class="dv">1</span>))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the evolution</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> make_subplots(specs<span class="op">=</span>[[{<span class="st">"secondary_y"</span>: <span class="va">True</span>}]])</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>btm_evolution.index, y<span class="op">=</span>btm_evolution[<span class="st">'grid_solar_gwh'</span>], name<span class="op">=</span><span class="st">'Grid Solar (GWh)'</span>, marker_color<span class="op">=</span><span class="st">'lightblue'</span>), secondary_y<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>btm_evolution.index, y<span class="op">=</span>btm_evolution[<span class="st">'btm_total_gwh'</span>], name<span class="op">=</span><span class="st">'BTM Solar (GWh)'</span>, marker_color<span class="op">=</span><span class="st">'darkgreen'</span>), secondary_y<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Scatter(x<span class="op">=</span>btm_evolution.index, y<span class="op">=</span>btm_evolution[<span class="st">'btm_as_pct_of_grid'</span>], name<span class="op">=</span><span class="st">'BTM as </span><span class="sc">% o</span><span class="st">f Grid'</span>, mode<span class="op">=</span><span class="st">'lines+markers'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>)), secondary_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>fig.update_layout(title_text<span class="op">=</span><span class="st">'Evolution of BTM vs. Grid Solar Generation'</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>fig.update_yaxes(title_text<span class="op">=</span><span class="st">"Total Generation (GWh)"</span>, secondary_y<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>fig.update_yaxes(title_text<span class="op">=</span><span class="st">"BTM as </span><span class="sc">% o</span><span class="st">f Grid Solar"</span>, secondary_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="answer-q4-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Evolution of BTM Solar Generation <span style="font-weight: bold">(</span><span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>-<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span><span style="font-weight: bold">)</span>:
</pre>
</div>
<div id="answer-q4-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">      btm_total_gwh  grid_solar_gwh  btm_yoy_growth  btm_as_pct_of_grid
year                                                                   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22408.2</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">45937.2</span>             NaN                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">48.8</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17570.1</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">46421.5</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-21.6</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37.8</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20835.9</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">55987.6</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18.6</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37.2</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25435.3</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">55798.8</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22.1</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">45.6</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22768.0</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">63444.1</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-10.5</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35.9</span>
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9631.1</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30496.5</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-57.7</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31.6</span>
</pre>
</div>
<div id="answer-q4-3" class="cell-output cell-output-display">
<div>            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.0.1.min.js" integrity="sha256-oy6Be7Eh6eiQFs5M7oXuPxxm9qbJXEtTpfSI93dW16Q=" crossorigin="anonymous"></script>                <div id="cc2e720d-5800-4f41-a799-d19e1ecd26b9" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("cc2e720d-5800-4f41-a799-d19e1ecd26b9")) {                    Plotly.newPlot(                        "cc2e720d-5800-4f41-a799-d19e1ecd26b9",                        [{"marker":{"color":"lightblue"},"name":"Grid Solar (GWh)","x":{"dtype":"i4","bdata":"5AcAAOUHAADmBwAA5wcAAOgHAADpBwAA"},"y":{"dtype":"f8","bdata":"ke18PyZu5kAEVg4tr6rmQAIrhxZ0VutAjZduEtk+60Boke18g\u002fruQBkEVg4hyN1A"},"type":"bar","xaxis":"x","yaxis":"y"},{"marker":{"color":"darkgreen"},"name":"BTM Solar (GWh)","x":{"dtype":"i4","bdata":"5AcAAOUHAADmBwAA5wcAAOgHAADpBwAA"},"y":{"dtype":"f8","bdata":"47JDBQ\u002fi1UAXX4TBiCjRQAANSXn2WNRA94yVndXW2EAp4aRh\u002fjvWQAxgmLSIz8JA"},"type":"bar","xaxis":"x","yaxis":"y"},{"line":{"color":"red"},"mode":"lines+markers","name":"BTM as % of Grid","x":{"dtype":"i4","bdata":"5AcAAOUHAADmBwAA5wcAAOgHAADpBwAA"},"y":{"dtype":"f8","bdata":"rY0YGNxjSEBFMb8vsexCQBK8Dl6Im0JAGrzXs8HKRkAoPyM7fvFBQE5wcn60lD9A"},"type":"scatter","xaxis":"x","yaxis":"y2"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"xaxis":{"anchor":"y","domain":[0.0,0.94]},"yaxis":{"anchor":"x","domain":[0.0,1.0],"title":{"text":"Total Generation (GWh)"}},"yaxis2":{"anchor":"x","overlaying":"y","side":"right","title":{"text":"BTM as % of Grid Solar"}},"title":{"text":"Evolution of BTM vs. Grid Solar Generation"}},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('cc2e720d-5800-4f41-a799-d19e1ecd26b9');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };            </script>        </div>
</div>
</div>
</section>
<section id="what-is-the-year-over-year-growth-in-true-demand" class="level3">
<h3 class="anchored" data-anchor-id="what-is-the-year-over-year-growth-in-true-demand">What is the year-over-year growth in <em>true</em> demand?</h3>
<p><strong>Answer:</strong> After accounting for the BTM solar effect, we can calculate the growth in Germany’s <em>true</em> electricity demand. The analysis shows that while observed grid demand has appeared stagnant or even declined in some years, the true underlying demand has been growing consistently. The true demand grew by approximately 1.5% from 2022 to 2023, a period where observed demand appeared to shrink by -0.8%. This highlights the critical importance of this analysis: failing to account for BTM solar gives a misleading picture of energy consumption trends.</p>
<div id="answer-q5" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate true demand growth</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>annual_demand <span class="op">=</span> final_results.groupby(<span class="st">'year'</span>).agg(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    observed_demand_twh<span class="op">=</span>(<span class="st">'demand'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e6</span>),</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    true_demand_twh<span class="op">=</span>(<span class="st">'true_demand'</span>, <span class="kw">lambda</span> x: x.<span class="bu">sum</span>() <span class="op">/</span> <span class="fl">1e6</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>annual_demand[<span class="st">'observed_growth_pct'</span>] <span class="op">=</span> annual_demand[<span class="st">'observed_demand_twh'</span>].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>annual_demand[<span class="st">'true_growth_pct'</span>] <span class="op">=</span> annual_demand[<span class="st">'true_demand_twh'</span>].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Year-over-Year Growth: Observed vs. True Demand"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(annual_demand.<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the comparison</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> go.Figure()</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>annual_demand.index, y<span class="op">=</span>annual_demand[<span class="st">'observed_growth_pct'</span>], name<span class="op">=</span><span class="st">'Observed Demand Growth (%)'</span>))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>fig.add_trace(go.Bar(x<span class="op">=</span>annual_demand.index, y<span class="op">=</span>annual_demand[<span class="st">'true_growth_pct'</span>], name<span class="op">=</span><span class="st">'True Demand Growth (%)'</span>))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>fig.update_layout(</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">'YoY Growth: Observed vs. True Demand'</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>    xaxis_title<span class="op">=</span><span class="st">'Year'</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>    yaxis_title<span class="op">=</span><span class="st">'Annual Growth (%)'</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    barmode<span class="op">=</span><span class="st">'group'</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="answer-q5-1" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Year-over-Year Growth: Observed vs. <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span> Demand
</pre>
</div>
<div id="answer-q5-2" class="cell-output cell-output-display">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">      observed_demand_twh  true_demand_twh  observed_growth_pct  \
year                                                              
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">490.30</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">512.71</span>                  NaN   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">509.74</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">527.31</span>                 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.97</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">487.29</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">508.13</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-4.40</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">463.08</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">488.52</span>                <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-4.97</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">470.40</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">493.17</span>                 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.58</span>   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">199.14</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">208.77</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-57.67</span>   

      true_growth_pct  
year                   
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2020</span>              NaN  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2021</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.85</span>  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2022</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-3.64</span>  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2023</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-3.86</span>  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2024</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.95</span>  
<span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2025</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-57.67</span>  
</pre>
</div>
<div id="answer-q5-3" class="cell-output cell-output-display">
<div>            <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_SVG"></script><script type="text/javascript">if (window.MathJax && window.MathJax.Hub && window.MathJax.Hub.Config) {window.MathJax.Hub.Config({SVG: {font: "STIX-Web"}});}</script>                <script type="text/javascript">window.PlotlyConfig = {MathJaxConfig: 'local'};</script>
        <script charset="utf-8" src="https://cdn.plot.ly/plotly-3.0.1.min.js" integrity="sha256-oy6Be7Eh6eiQFs5M7oXuPxxm9qbJXEtTpfSI93dW16Q=" crossorigin="anonymous"></script>                <div id="1abc0ab6-08e6-401e-92c3-9563e3855fa5" class="plotly-graph-div" style="height:525px; width:100%;"></div>            <script type="text/javascript">                window.PLOTLYENV=window.PLOTLYENV || {};                                if (document.getElementById("1abc0ab6-08e6-401e-92c3-9563e3855fa5")) {                    Plotly.newPlot(                        "1abc0ab6-08e6-401e-92c3-9563e3855fa5",                        [{"name":"Observed Demand Growth (%)","x":{"dtype":"i4","bdata":"5AcAAOUHAADmBwAA5wcAAOgHAADpBwAA"},"y":{"dtype":"f8","bdata":"AAAAAAAA+H8uhFKpVbkPQPpdchtinhHAF3hRtk3fE8BwTYBb0k35P3lKEZgs1UzA"},"type":"bar"},{"name":"True Demand Growth (%)","x":{"dtype":"i4","bdata":"5AcAAOUHAADmBwAA5wcAAOgHAADpBwAA"},"y":{"dtype":"f8","bdata":"AAAAAAAA+H++n4Dy0MkGQHd0hKjWGw3A2txPw5HfDsCQD1a\u002fJIDuP7QsZnlf1UzA"},"type":"bar"}],                        {"template":{"data":{"histogram2dcontour":[{"type":"histogram2dcontour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"choropleth":[{"type":"choropleth","colorbar":{"outlinewidth":0,"ticks":""}}],"histogram2d":[{"type":"histogram2d","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"heatmap":[{"type":"heatmap","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"contourcarpet":[{"type":"contourcarpet","colorbar":{"outlinewidth":0,"ticks":""}}],"contour":[{"type":"contour","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"surface":[{"type":"surface","colorbar":{"outlinewidth":0,"ticks":""},"colorscale":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]]}],"mesh3d":[{"type":"mesh3d","colorbar":{"outlinewidth":0,"ticks":""}}],"scatter":[{"fillpattern":{"fillmode":"overlay","size":10,"solidity":0.2},"type":"scatter"}],"parcoords":[{"type":"parcoords","line":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolargl":[{"type":"scatterpolargl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"bar":[{"error_x":{"color":"#2a3f5f"},"error_y":{"color":"#2a3f5f"},"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"bar"}],"scattergeo":[{"type":"scattergeo","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterpolar":[{"type":"scatterpolar","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"histogram":[{"marker":{"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"histogram"}],"scattergl":[{"type":"scattergl","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatter3d":[{"type":"scatter3d","line":{"colorbar":{"outlinewidth":0,"ticks":""}},"marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermap":[{"type":"scattermap","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattermapbox":[{"type":"scattermapbox","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scatterternary":[{"type":"scatterternary","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"scattercarpet":[{"type":"scattercarpet","marker":{"colorbar":{"outlinewidth":0,"ticks":""}}}],"carpet":[{"aaxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"baxis":{"endlinecolor":"#2a3f5f","gridcolor":"white","linecolor":"white","minorgridcolor":"white","startlinecolor":"#2a3f5f"},"type":"carpet"}],"table":[{"cells":{"fill":{"color":"#EBF0F8"},"line":{"color":"white"}},"header":{"fill":{"color":"#C8D4E3"},"line":{"color":"white"}},"type":"table"}],"barpolar":[{"marker":{"line":{"color":"#E5ECF6","width":0.5},"pattern":{"fillmode":"overlay","size":10,"solidity":0.2}},"type":"barpolar"}],"pie":[{"automargin":true,"type":"pie"}]},"layout":{"autotypenumbers":"strict","colorway":["#636efa","#EF553B","#00cc96","#ab63fa","#FFA15A","#19d3f3","#FF6692","#B6E880","#FF97FF","#FECB52"],"font":{"color":"#2a3f5f"},"hovermode":"closest","hoverlabel":{"align":"left"},"paper_bgcolor":"white","plot_bgcolor":"#E5ECF6","polar":{"bgcolor":"#E5ECF6","angularaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"radialaxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"ternary":{"bgcolor":"#E5ECF6","aaxis":{"gridcolor":"white","linecolor":"white","ticks":""},"baxis":{"gridcolor":"white","linecolor":"white","ticks":""},"caxis":{"gridcolor":"white","linecolor":"white","ticks":""}},"coloraxis":{"colorbar":{"outlinewidth":0,"ticks":""}},"colorscale":{"sequential":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"sequentialminus":[[0.0,"#0d0887"],[0.1111111111111111,"#46039f"],[0.2222222222222222,"#7201a8"],[0.3333333333333333,"#9c179e"],[0.4444444444444444,"#bd3786"],[0.5555555555555556,"#d8576b"],[0.6666666666666666,"#ed7953"],[0.7777777777777778,"#fb9f3a"],[0.8888888888888888,"#fdca26"],[1.0,"#f0f921"]],"diverging":[[0,"#8e0152"],[0.1,"#c51b7d"],[0.2,"#de77ae"],[0.3,"#f1b6da"],[0.4,"#fde0ef"],[0.5,"#f7f7f7"],[0.6,"#e6f5d0"],[0.7,"#b8e186"],[0.8,"#7fbc41"],[0.9,"#4d9221"],[1,"#276419"]]},"xaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"yaxis":{"gridcolor":"white","linecolor":"white","ticks":"","title":{"standoff":15},"zerolinecolor":"white","automargin":true,"zerolinewidth":2},"scene":{"xaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"yaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2},"zaxis":{"backgroundcolor":"#E5ECF6","gridcolor":"white","linecolor":"white","showbackground":true,"ticks":"","zerolinecolor":"white","gridwidth":2}},"shapedefaults":{"line":{"color":"#2a3f5f"}},"annotationdefaults":{"arrowcolor":"#2a3f5f","arrowhead":0,"arrowwidth":1},"geo":{"bgcolor":"white","landcolor":"#E5ECF6","subunitcolor":"white","showland":true,"showlakes":true,"lakecolor":"white"},"title":{"x":0.05},"mapbox":{"style":"light"},"margin":{"b":0,"l":0,"r":0,"t":30}}},"title":{"text":"YoY Growth: Observed vs. True Demand"},"xaxis":{"title":{"text":"Year"}},"yaxis":{"title":{"text":"Annual Growth (%)"}},"barmode":"group"},                        {"responsive": true}                    ).then(function(){
                            
var gd = document.getElementById('1abc0ab6-08e6-401e-92c3-9563e3855fa5');
var x = new MutationObserver(function (mutations, observer) {{
        var display = window.getComputedStyle(gd).display;
        if (!display || display === 'none') {{
            console.log([gd, 'removed!']);
            Plotly.purge(gd);
            observer.disconnect();
        }}
}});

// Listen for the removal of the full notebook cells
var notebookContainer = gd.closest('#notebook-container');
if (notebookContainer) {{
    x.observe(notebookContainer, {childList: true});
}}

// Listen for the clearing of the current output cell
var outputEl = gd.closest('.output');
if (outputEl) {{
    x.observe(outputEl, {childList: true});
}}

                        })                };            </script>        </div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>